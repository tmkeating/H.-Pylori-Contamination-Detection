Synchronizing dataset to local scratch: /tmp/ricse03_h_pylori_data
Data synchronization complete.
Starting Training for Fold: 4 of 5 using convnext_tiny
--- Starting Run ID: 116 (Fold: 5/5, Model: convnext_tiny, SLURM Job: 103190) ---
Using device: cuda
Set float32 matmul precision to 'high' for A40 hardware optimization.
Using Data Path: /tmp/ricse03_h_pylori_data
Pre-processing: Using Standard ImageNet Normalization (IHC-mode).
--- Fold 5/5 Split ---
Total Patients: 155
Training Patients: 124
Validation Patients: 31
Independent Patient-level split:
 - Train: 124 patients, 99973 patches
 - Val:   31 patients, 30222 patches
Training distribution: Negative=54042, Contaminated=45931
Enabling torch.compile for convnext_tiny Optimization (5D)...
Using AdamW Optimizer for convnext_tiny stability...
Running on standard PyTorch (IPEX disabled).
Epoch 1/15
Train Loss: 0.2208 Acc: 0.6627
Val Loss: 0.1976 Acc: 0.7546
Best model saved to results/116_103190_f4_convnext_tiny_model_brain.pth (Val Loss: 0.1976)
Epoch 2/15
Train Loss: 0.1745 Acc: 0.7634
Val Loss: 0.1874 Acc: 0.7659
Best model saved to results/116_103190_f4_convnext_tiny_model_brain.pth (Val Loss: 0.1874)
Epoch 3/15
Train Loss: 0.1582 Acc: 0.7911
Val Loss: 0.2050 Acc: 0.7045
Epoch 4/15
Train Loss: 0.1450 Acc: 0.8133
Val Loss: 0.2161 Acc: 0.7020
Epoch 5/15
Train Loss: 0.1369 Acc: 0.8256
Val Loss: 0.2226 Acc: 0.7053
Epoch 6/15
Train Loss: 0.1304 Acc: 0.8353
Val Loss: 0.2099 Acc: 0.7357
Epoch 7/15
Train Loss: 0.1234 Acc: 0.8452
Val Loss: 0.1698 Acc: 0.7863
Best model saved to results/116_103190_f4_convnext_tiny_model_brain.pth (Val Loss: 0.1698)
Epoch 8/15
Train Loss: 0.1155 Acc: 0.8565
Val Loss: 0.2122 Acc: 0.7803
Epoch 9/15
Train Loss: 0.1090 Acc: 0.8669
Val Loss: 0.1952 Acc: 0.7753
Epoch 10/15
Train Loss: 0.1033 Acc: 0.8735
Val Loss: 0.1883 Acc: 0.7986
Epoch 11/15
Train Loss: 0.0957 Acc: 0.8849
Val Loss: 0.2085 Acc: 0.7976
Epoch 12/15
Train Loss: 0.0930 Acc: 0.8872
Val Loss: 0.2119 Acc: 0.7975
Epoch 13/15
Train Loss: 0.0910 Acc: 0.8910
Val Loss: 0.2050 Acc: 0.7993
Epoch 14/15
Train Loss: 0.0896 Acc: 0.8928
Val Loss: 0.2146 Acc: 0.7927
Epoch 15/15
Train Loss: 0.0883 Acc: 0.8948
Val Loss: 0.2133 Acc: 0.7935
Training complete. Best Val Loss: 0.1698
Fold 4 finished.
Saved learning curves to results/116_103190_f4_convnext_tiny_learning_curves.png

Evaluating on Independent Hold-Out set from: /tmp/ricse03_h_pylori_data/HoldOut
Independent Patients in Hold-Out: 116
Total Patches in Hold-Out: 88794

Classification Report:
              precision    recall  f1-score   support

    Negative       0.67      0.86      0.75     47557
Contaminated       0.75      0.51      0.61     41237

    accuracy                           0.69     88794
   macro avg       0.71      0.68      0.68     88794
weighted avg       0.71      0.69      0.68     88794

Saved machine-readable report to results/116_103190_f4_convnext_tiny_evaluation_report.csv
Saved results/116_103190_f4_convnext_tiny_confusion_matrix.png
Saved results/116_103190_f4_convnext_tiny_roc_curve.png
Saved results/116_103190_f4_convnext_tiny_pr_curve.png
Saved results/116_103190_f4_convnext_tiny_probability_histogram.png
Generating Grad-CAM interpretability maps for convnext_tiny...
Saved Grad-CAM samples to results/116_103190_f4_convnext_tiny_gradcam_samples

--- Patient-Level Consensus Report (Independent Set) ---
Warning: Meta-model not found. Falling back to heuristic gates.
No Meta-Classifier found. Using Heuristic Gates (Fallback)...
Patient Consensus Report saved to: results/116_103190_f4_convnext_tiny_patient_consensus.csv

Detailed Patient-Level Metrics (Clinical Report):
PatientID   Actual Predicted  Mean_Prob  Max_Prob  Count_P90  Patch_Count Correct
   B22-01 Positive  Negative   0.223539  0.622070          0          486      No
   B22-02 Positive  Positive   0.698425  0.995605        133          391     Yes
   B22-03 Negative  Negative   0.223539  0.622070          0          486     Yes
   B22-04 Negative  Negative   0.239471  0.645020          0          287     Yes
   B22-05 Negative  Negative   0.377142  0.953125          8          810     Yes
   B22-06 Negative  Negative   0.251956  0.900391          1          891     Yes
   B22-07 Negative  Negative   0.293778  0.601074          0          154     Yes
   B22-08 Negative  Negative   0.179082  0.667969          0          321     Yes
   B22-09 Negative  Negative   0.262111  0.845703          0          360     Yes
  B22-100 Positive  Positive   0.606658  0.995605         84          400     Yes
  B22-105 Positive  Negative   0.423403  0.983398         11          412      No
   B22-10 Negative  Negative   0.355960  0.957031         29         1822     Yes
   B22-11 Negative  Negative   0.378978  0.950195          6         1217     Yes
  B22-120 Positive  Positive   0.657456  0.994629        126          719     Yes
  B22-128 Positive  Positive   0.665948  0.991211         49          184     Yes
   B22-12 Negative  Negative   0.466610  0.952637         13          821     Yes
  B22-130 Positive  Positive   0.322307  0.995117         74          849     Yes
  B22-132 Positive  Positive   0.711492  0.997070        306          729     Yes
  B22-134 Positive  Positive   0.566044  0.995117         41          296     Yes
  B22-135 Positive  Positive   0.696622  0.996582        278          688     Yes
  B22-136 Positive  Positive   0.591513  0.996094        213         1252     Yes
  B22-139 Positive  Negative   0.517411  0.976562         16          330      No
   B22-13 Negative  Negative   0.335606  0.792480          0         1104     Yes
  B22-146 Negative  Negative   0.275841  0.798340          0          325     Yes
   B22-14 Negative  Negative   0.428363  0.907227          1          676     Yes
  B22-159 Positive  Positive   0.521272  0.991211        150         1208     Yes
   B22-15 Negative  Negative   0.269889  0.700195          0         1206     Yes
  B22-161 Positive  Positive   0.482740  0.997070        220         1795     Yes
  B22-169 Positive  Positive   0.540644  0.994629         86          462     Yes
   B22-16 Negative  Negative   0.314371  0.897949          0          237     Yes
   B22-17 Positive  Positive   0.509223  0.993164         45          625     Yes
   B22-18 Positive  Positive   0.520563  0.996094        155          953     Yes
  B22-196 Negative  Negative   0.379956  0.699707          0          179     Yes
  B22-198 Negative  Negative   0.261406  0.669434          0          223     Yes
  B22-199 Negative  Negative   0.334081  0.751953          0          438     Yes
   B22-19 Positive  Positive   0.695689  0.997070        163          395     Yes
  B22-201 Negative  Negative   0.302734  0.795410          0          744     Yes
  B22-202 Negative  Negative   0.330914  0.904785          1          964     Yes
  B22-203 Negative  Negative   0.246606  0.819336          0          730     Yes
  B22-205 Negative  Negative   0.264801  0.711914          0          654     Yes
  B22-206 Positive  Negative   0.392571  0.898926          0          769      No
  B22-207 Negative  Negative   0.251869  0.726562          0          458     Yes
  B22-208 Negative  Negative   0.301319  0.833984          0         1419     Yes
  B22-209 Negative  Negative   0.306258  0.693359          0          677     Yes
   B22-20 Positive  Positive   0.414518  0.993164         47          720     Yes
  B22-211 Negative  Negative   0.368147  0.698242          0          377     Yes
  B22-212 Negative  Negative   0.250106  0.834473          0          898     Yes
  B22-213 Negative  Negative   0.240947  0.732910          0          520     Yes
  B22-215 Negative  Negative   0.239178  0.840332          0         1611     Yes
  B22-220 Negative  Negative   0.277595  0.706543          0         1212     Yes
  B22-222 Positive  Positive   0.615489  0.995605        127          742     Yes
  B22-224 Positive  Negative   0.406565  0.976562         12          341      No
  B22-225 Positive  Positive   0.604499  0.992188         86          637     Yes
  B22-226 Negative  Negative   0.163091  0.538086          0          269     Yes
  B22-227 Negative  Negative   0.232659  0.839355          0          773     Yes
  B22-229 Negative  Negative   0.308574  0.834473          0         2348     Yes
  B22-231 Positive  Positive   0.812797  0.997070       1140         1839     Yes
  B22-233 Negative  Negative   0.326928  0.708984          0          308     Yes
  B22-236 Negative  Negative   0.220699  0.796387          0         1471     Yes
  B22-237 Negative  Negative   0.343278  0.817871          0          876     Yes
  B22-238 Negative  Negative   0.363464  0.740723          0          236     Yes
  B22-239 Negative  Negative   0.278204  0.892578          0          568     Yes
  B22-242 Negative  Negative   0.369044  0.883301          0          545     Yes
  B22-243 Negative  Negative   0.287304  0.835938          0          776     Yes
  B22-246 Negative  Negative   0.327094  0.892578          0          363     Yes
  B22-247 Negative  Negative   0.344829  0.876465          0         1182     Yes
  B22-252 Negative  Negative   0.237713  0.844727          0          342     Yes
  B22-255 Positive  Positive   0.686696  0.997559        484         1243     Yes
  B22-257 Negative  Negative   0.302334  0.921875          2          193     Yes
  B22-259 Negative  Negative   0.303477  0.790527          0         1217     Yes
  B22-261 Negative  Negative   0.296505  0.834473          0          330     Yes
  B22-262 Positive  Negative   0.280218  0.896973          0          644      No
  B22-263 Positive  Positive   0.559986  0.993164         72          323     Yes
  B22-266 Negative  Negative   0.296033  0.857910          0          832     Yes
  B22-267 Positive  Positive   0.704081  0.996582        141          366     Yes
  B22-268 Negative  Negative   0.301515  0.786133          0         1092     Yes
  B22-269 Negative  Negative   0.327664  0.756348          0          838     Yes
  B22-271 Negative  Negative   0.357326  0.898926          0         1135     Yes
  B22-272 Positive  Negative   0.486717  0.982422          5          565      No
  B22-273 Positive  Positive   0.618585  0.996094        133          439     Yes
  B22-281 Positive  Positive   0.588209  0.997070        123          560     Yes
  B22-282 Negative  Negative   0.231347  0.643555          0          338     Yes
  B22-283 Negative  Negative   0.309376  0.810547          0          418     Yes
  B22-285 Negative  Negative   0.325455  0.815430          0          556     Yes
  B22-286 Positive  Negative   0.382072  0.983887          7         1167      No
  B22-293 Positive  Positive   0.579292  0.992188         51          364     Yes
  B22-294 Positive  Negative   0.451774  0.995605          9          760      No
  B22-295 Positive  Negative   0.343027  0.982422         13          762      No
  B22-309 Positive  Positive   0.412529  0.995117         71          893     Yes
  B22-310 Positive  Positive   0.420775  0.996582        212         1034     Yes
  B22-314 Negative  Negative   0.321084  0.916016          2          349     Yes
  B22-315 Negative  Negative   0.135273  0.807129          0          607     Yes
   B22-31 Positive  Positive   0.607355  0.993652         70          456     Yes
   B22-32 Positive  Positive   0.480930  0.996582        102          803     Yes
   B22-36 Positive  Negative   0.411132  0.990723         19          379      No
   B22-39 Positive  Positive   0.603679  0.996094         62          371     Yes
   B22-41 Positive  Positive   0.569483  0.988770         65          444     Yes
   B22-44 Positive  Negative   0.303940  0.988770          4          945      No
   B22-48 Positive  Negative   0.688808  0.994141         38          580      No
   B22-49 Positive  Negative   0.410521  0.979004         23          986      No
   B22-58 Negative  Negative   0.212780  0.675781          0          283     Yes
   B22-62 Positive  Positive   0.779669  0.997559        330          637     Yes
   B22-65 Positive  Positive   0.860925  0.997559        291          434     Yes
   B22-66 Positive  Positive   0.755266  0.988770         80          349     Yes
   B22-69 Positive  Negative   0.489348  0.958984          5          385      No
   B22-72 Positive  Positive   0.825399  0.997070       1062         2021     Yes
   B22-73 Positive  Positive   0.769544  0.993164         96          333     Yes
   B22-75 Positive  Positive   0.646696  0.996582        277         1199     Yes
   B22-78 Positive  Positive   0.732061  0.995117         67          195     Yes
   B22-79 Positive  Positive   0.751448  0.995605        269          798     Yes
   B22-81 Positive  Negative   0.534216  0.841309          0          134      No
   B22-82 Positive  Negative   0.266565  0.977539          5          598      No
   B22-85 Positive  Negative   0.237333  0.728027          0          814      No
   B22-88 Negative  Negative   0.390016  0.863281          0          139     Yes
   B22-89 Negative  Negative   0.373715  0.960938          4         7352     Yes
   B22-96 Positive  Positive   0.464307  0.994629         55         2034     Yes

Generating Patient-Level Visualizations...
Saved patient-level plots to results

Final Patient-Level Accuracy: 84.48%
